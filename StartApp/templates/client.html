<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StartupHub - Платформа для підтримки стартап проектів</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Додаємо Leaflet для карт -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1>StartupHub</h1>
                <span>LET'S BE THINKERS</span>
            </div>
            <nav>
                <ul>
                    <li><a href="{{ url_for('index') }}"><i class="fas fa-home"></i> Головна</a></li>
                    {% if session.user_id %}
                    <li><a href="{{ url_for('create_idea') }}"><i class="fas fa-lightbulb"></i> Створити ідею</a></li>
                    <li><a href="{{ url_for('find_nearby_users') }}"><i class="fas fa-users"></i> Знайти команду</a></li>
                    <li>
                        <a href="{{ url_for('messages') }}">
                            <i class="fas fa-envelope"></i> Повідомлення
                            <span id="unread-badge" class="badge" style="display: none;"></span>
                        </a>
                    </li>
                    <li><a href="{{ url_for('profile', username=session.username) }}"><i class="fas fa-user"></i> Мій профіль</a></li>
                    {% if session.role == 'admin' %}
                    <li class="dropdown">
                        <a href="#"><i class="fas fa-cog"></i> Адмін <i class="fas fa-caret-down"></i></a>
                        <div class="dropdown-content">
                            <a href="{{ url_for('admin_users') }}">Користувачі</a>
                            <a href="{{ url_for('admin_ideas') }}">Ідеї</a>
                            <a href="{{ url_for('create_media_placeholders') }}">Створити заглушки для медіа</a>
                        </div>
                    </li>
                    {% endif %}
                    <li><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Вийти</a></li>
                    {% else %}
                    <li><a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> Увійти</a></li>
                    <li><a href="{{ url_for('register') }}"><i class="fas fa-user-plus"></i> Зареєструватися</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="container">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">
                {{ message }}
                <span class="alert-close" onclick="this.parentElement.style.display='none'">&times;</span>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            {% if action == 'login' %}
            <!-- Форма входу -->
            <div class="auth-form">
                <h2>Вхід на платформу</h2>
                <form action="{{ url_for('login') }}" method="post">
                    <div class="form-group">
                        <label for="username">Ім'я користувача:</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Пароль:</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Увійти</button>
                </form>
                <p class="form-footer">Ще не маєте акаунта? <a href="{{ url_for('register') }}">Зареєструватись</a></p>
            </div>

            {% elif action == 'register' %}
            <!-- Форма реєстрації з геолокацією -->
            <div class="auth-form">
                <h2>Реєстрація на платформі</h2>
                <form action="{{ url_for('register') }}" method="post">
                    <div class="form-group">
                        <label for="username">Ім'я користувача:</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Електронна пошта:</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="full_name">Повне ім'я:</label>
                        <input type="text" id="full_name" name="full_name" required>
                    </div>
                    <!-- Нові поля геолокації -->
                    <div class="form-group">
                        <label for="city">Місто:</label>
                        <input type="text" id="city" name="city">
                    </div>
                    <div class="form-group">
                        <label for="country">Країна:</label>
                        <input type="text" id="country" name="country">
                    </div>
                    <div class="form-group">
                        <button type="button" id="getLocationBtn" class="btn btn-secondary">
                            <i class="fas fa-map-marker-alt"></i> Визначити моє місцезнаходження
                        </button>
                        <div id="locationStatus"></div>
                    </div>
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                    <!-- Кінець нових полів геолокації -->
                    <div class="form-group">
                        <label for="password">Пароль:</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <div class="form-group">
                        <label for="confirm_password">Підтвердження паролю:</label>
                        <input type="password" id="confirm_password" name="confirm_password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Зареєструватись</button>
                </form>
                <p class="form-footer">Вже маєте акаунт? <a href="{{ url_for('login') }}">Увійти</a></p>
            </div>

            {% elif action == 'profile' %}
            <!-- Профіль користувача з геолокацією -->
            <div class="profile-container">
                <div class="profile-header">
                    <div class="profile-avatar">{{ user.username[0] | upper }}</div>
                    <div class="profile-info">
                        <h2>{{ user.full_name }}</h2>
                        <p class="username">@{{ user.username }}</p>
                        <p class="email">{{ user.email }}</p>
                        {% if user.city and user.country %}
                        <p class="location"><i class="fas fa-map-marker-alt"></i> {{ user.city }}, {{ user.country }}</p>
                        {% endif %}
                        {% if user.bio %}
                        <p class="bio">{{ user.bio }}</p>
                        {% endif %}
                        {% if session.user_id == user.id %}
                        <a href="{{ url_for('edit_profile') }}" class="btn btn-secondary">Редагувати профіль</a>
                        {% else %}
                        <a href="{{ url_for('new_chat', user_id=user.id) }}" class="btn btn-secondary">
                            <i class="fas fa-envelope"></i> Надіслати повідомлення
                        </a>
                        {% endif %}
                    </div>
                </div>

                <!-- Карта місцезнаходження, якщо є координати -->
                {% if user.latitude and user.longitude %}
                <div class="profile-map">
                    <h3>Місцезнаходження</h3>
                    <div id="userLocationMap" style="height: 250px;"></div>
                    <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    var map = L.map('userLocationMap').setView([{{ user.latitude }}, {{ user.longitude }}], 13);
                                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                                    }).addTo(map);
                                    L.marker([{{ user.latitude }}, {{ user.longitude }}]).addTo(map)
                                        .bindPopup('{{ user.city }}, {{ user.country }}')
                                        .openPopup();
                                });
                    </script>
                </div>
                {% endif %}

                <div class="profile-content">
                    <h3>Ідеї користувача</h3>
                    {% if ideas %}
                    <div class="ideas-container">
                        {% for idea in ideas %}
                        <div class="idea-card">
                            <div class="idea-header">
                                <div class="user-info">
                                    <div class="time">{{ idea.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
                                </div>
                                <div class="idea-actions">
                                    <a href="{{ url_for('view_idea', idea_id=idea.id) }}" class="btn btn-primary"><i class="fas fa-eye"></i> Переглянути</a>
                                    {% if session.user_id == user.id or session.role == 'admin' %}
                                    <a href="{{ url_for('edit_idea', idea_id=idea.id) }}" class="btn btn-secondary"><i class="fas fa-edit"></i> Редагувати</a>
                                    <form action="{{ url_for('delete_idea', idea_id=idea.id) }}" method="post" class="inline-form">
                                        <button type="submit" class="btn btn-danger" onclick="return confirm('Ви впевнені, що хочете видалити цю ідею?')">
                                            <i class="fas fa-trash"></i> Видалити
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="idea-content">
                                <h3>{{ idea.title }}</h3>
                                <p>{{ idea.description[:200] }}{% if idea.description|length > 200 %}...{% endif %}</p>
                            </div>
                            <div class="idea-footer">
                                <div class="idea-stats">
                                    <span><i class="fas fa-comment"></i> {{ idea.comment_count }} коментарів</span>
                                    <span><i class="fas fa-photo-video"></i> {{ idea.media_count }} медіа</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="no-content">
                        <p>У користувача ще немає ідей.</p>
                        {% if session.user_id == user.id %}
                        <a href="{{ url_for('create_idea') }}" class="btn btn-primary">Створити ідею</a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            {% elif action == 'edit_profile' %}
            <!-- Редагування профілю з геолокацією -->
            <div class="auth-form">
                <h2>Редагування профілю</h2>
                <form action="{{ url_for('edit_profile') }}" method="post">
                    <div class="form-group">
                        <label for="full_name">Повне ім'я:</label>
                        <input type="text" id="full_name" name="full_name" value="{{ user.full_name }}" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Електронна пошта:</label>
                        <input type="email" id="email" name="email" value="{{ user.email }}" required>
                    </div>
                    <div class="form-group">
                        <label for="bio">Про себе:</label>
                        <textarea id="bio" name="bio" rows="4">{{ user.bio or '' }}</textarea>
                    </div>
                    <!-- Геолокація -->
                    <div class="form-group">
                        <label for="city">Місто:</label>
                        <input type="text" id="city" name="city" value="{{ user.city or '' }}">
                    </div>
                    <div class="form-group">
                        <label for="country">Країна:</label>
                        <input type="text" id="country" name="country" value="{{ user.country or '' }}">
                    </div>
                    <div class="form-group">
                        <button type="button" id="getLocationBtn" class="btn btn-secondary">
                            <i class="fas fa-map-marker-alt"></i> Оновити моє місцезнаходження
                        </button>
                        <div id="locationStatus"></div>
                    </div>
                    <input type="hidden" id="latitude" name="latitude" value="{{ user.latitude or '' }}">
                    <input type="hidden" id="longitude" name="longitude" value="{{ user.longitude or '' }}">

                    {% if user.latitude and user.longitude %}
                    <div id="currentLocationMap" style="height: 250px; margin-bottom: 20px;"></div>
                    <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    var map = L.map('currentLocationMap').setView([{{ user.latitude }}, {{ user.longitude }}], 13);
                                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                                    }).addTo(map);
                                    L.marker([{{ user.latitude }}, {{ user.longitude }}]).addTo(map)
                                        .bindPopup('{{ user.city }}, {{ user.country }}')
                                        .openPopup();
                                });
                    </script>
                    {% endif %}
                    <!-- Кінець геолокації -->

                    <button type="submit" class="btn btn-primary">Зберегти зміни</button>
                </form>

                <h3>Змінити пароль</h3>
                <form action="{{ url_for('change_password') }}" method="post">
                    <div class="form-group">
                        <label for="current_password">Поточний пароль:</label>
                        <input type="password" id="current_password" name="current_password" required>
                    </div>
                    <div class="form-group">
                        <label for="new_password">Новий пароль:</label>
                        <input type="password" id="new_password" name="new_password" required>
                    </div>
                    <div class="form-group">
                        <label for="confirm_password">Підтвердження паролю:</label>
                        <input type="password" id="confirm_password" name="confirm_password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Змінити пароль</button>
                </form>
            </div>

            {% elif action == 'create_idea' %}
            <!-- Створення ідеї з підтримкою медіа-файлів -->
            <div class="auth-form">
                <h2>Створити нову ідею</h2>
                <form action="{{ url_for('create_idea') }}" method="post" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="title">Назва ідеї:</label>
                        <input type="text" id="title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Опис ідеї:</label>
                        <textarea id="description" name="description" rows="6" required></textarea>
                    </div>

                    <!-- Додавання медіа файлів -->
                    <div class="form-group">
                        <label for="media_files">Медіа файли (зображення та відео):</label>
                        <input type="file" id="media_files" name="media_files" multiple accept="image/*,video/*">
                        <small>Дозволені формати зображень: JPG, JPEG, PNG, GIF, WEBP</small><br>
                        <small>Дозволені формати відео: MP4, WEBM, AVI, MOV, MKV</small><br>
                        <small>Максимальний розмір файлу: 50 МБ</small>
                    </div>

                    <button type="submit" class="btn btn-primary">Створити ідею</button>
                </form>
            </div>

            {% elif action == 'edit_idea' %}
            <!-- Редагування ідеї з підтримкою медіа-файлів -->
            <div class="auth-form">
                <h2>Редагувати ідею</h2>
                <form action="{{ url_for('edit_idea', idea_id=idea.id) }}" method="post" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="title">Назва ідеї:</label>
                        <input type="text" id="title" name="title" value="{{ idea.title }}" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Опис ідеї:</label>
                        <textarea id="description" name="description" rows="6" required>{{ idea.description }}</textarea>
                    </div>

                    <!-- Поточні медіа файли -->
                    {% if media_files %}
                    <div class="form-group">
                        <label>Поточні медіа файли:</label>
                        <div class="media-files-container">
                            {% for media in media_files %}
                            <div class="media-file">
                                {% if media.file_type == 'image' %}
                                <img src="{{ url_for('uploaded_file', filename=media.file_path) }}" alt="Зображення" class="thumbnail">
                                {% else %}
                                <video src="{{ url_for('uploaded_file', filename=media.file_path) }}" class="thumbnail" controls></video>
                                {% endif %}
                                <div class="media-actions">
                                    <label>
                                        <input type="checkbox" name="delete_file" value="{{ media.id }}"> Видалити
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Додавання нових медіа файлів -->
                    <div class="form-group">
                        <label for="media_files">Додати нові медіа файли:</label>
                        <input type="file" id="media_files" name="media_files" multiple accept="image/*,video/*">
                        <small>Дозволені формати зображень: JPG, JPEG, PNG, GIF, WEBP</small><br>
                        <small>Дозволені формати відео: MP4, WEBM, AVI, MOV, MKV</small><br>
                        <small>Максимальний розмір файлу: 50 МБ</small>
                    </div>

                    <button type="submit" class="btn btn-primary">Зберегти зміни</button>
                </form>
            </div>

            {% elif action == 'view_idea' %}
            <!-- Перегляд ідеї з підтримкою медіа-файлів -->
            <div class="idea-detail">
                <div class="idea-card">
                    <div class="idea-header">
                        <div class="user-info">
                            <div class="user-avatar">{{ idea.username[0] | upper }}</div>
                            <div class="user-details">
                                <a href="{{ url_for('profile', username=idea.username) }}" class="username">{{ idea.full_name if idea.full_name else idea.username }}</a>
                                <span class="time">{{ idea.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                                {% if idea.city and idea.country %}
                                <span class="location"><i class="fas fa-map-marker-alt"></i> {{ idea.city }}, {{ idea.country }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="idea-actions">
                            {% if session.user_id == idea.user_id or session.role == 'admin' %}
                            <a href="{{ url_for('edit_idea', idea_id=idea.id) }}" class="btn btn-secondary"><i class="fas fa-edit"></i> Редагувати</a>
                            <form action="{{ url_for('delete_idea', idea_id=idea.id) }}" method="post" class="inline-form">
                                <button type="submit" class="btn btn-danger" onclick="return confirm('Ви впевнені, що хочете видалити цю ідею?')">
                                    <i class="fas fa-trash"></i> Видалити
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    <div class="idea-content">
                        <h3>{{ idea.title }}</h3>
                        <p>{{ idea.description }}</p>

                        <!-- Відображення медіа файлів -->
                        {% if media_files %}
                        <div class="media-gallery">
                            <h4>Медіа файли:</h4>
                            <div class="media-files-container">
                                {% for media in media_files %}
                                <div class="media-item">
                                    {% if media.file_type == 'image' %}
                                    <a href="{{ url_for('uploaded_file', filename=media.file_path) }}" target="_blank">
                                        <img src="{{ url_for('uploaded_file', filename=media.file_path) }}" alt="Зображення" class="media-preview">
                                    </a>
                                    {% else %}
                                    <video src="{{ url_for('uploaded_file', filename=media.file_path) }}" controls class="media-preview"></video>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Коментарі -->
                <div class="comments-section">
                    <h3>Коментарі ({{ comments|length }})</h3>

                    {% if session.user_id %}
                    <form action="{{ url_for('add_comment', idea_id=idea.id) }}" method="post" class="comment-form">
                        <div class="form-group">
                            <textarea name="content" placeholder="Додайте ваш коментар..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Додати коментар</button>
                    </form>
                    {% endif %}

                    <div class="comments-list">
                        {% if comments %}
                        {% for comment in comments %}
                        <div class="comment">
                            <div class="comment-header">
                                <div class="user-info">
                                    <div class="user-avatar">{{ comment.username[0] | upper }}</div>
                                    <div class="user-details">
                                        <a href="{{ url_for('profile', username=comment.username) }}" class="username">{{ comment.full_name if comment.full_name else comment.username }}</a>
                                        <span class="time">{{ comment.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                                        {% if comment.city and comment.country %}
                                        <span class="location"><i class="fas fa-map-marker-alt"></i> {{ comment.city }}, {{ comment.country }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if session.user_id == comment.user_id or session.role == 'admin' %}
                                <div class="comment-actions">
                                    <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="post" class="inline-form">
                                        <button type="submit" class="btn btn-danger-small" onclick="return confirm('Ви впевнені, що хочете видалити цей коментар?')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                            <div class="comment-content">
                                <p>{{ comment.content }}</p>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="no-content">
                            <p>Поки що немає коментарів. Будьте першим, хто прокоментує!</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% elif action == 'find_nearby_users' %}
            <!-- Пошук користувачів за місцем знаходження -->
            <div class="nearby-users">
                <h2>Пошук учасників команди</h2>

                <form action="{{ url_for('find_nearby_users') }}" method="post" class="search-form">
                    <div class="form-group">
                        <label for="city">Місто:</label>
                        <input type="text" id="city" name="city" value="{{ search_city or '' }}">
                    </div>
                    <div class="form-group">
                        <label for="country">Країна:</label>
                        <input type="text" id="country" name="country" value="{{ search_country or '' }}">
                    </div>
                    <button type="submit" class="btn btn-primary">Шукати</button>
                </form>

                {% if users %}
                <div class="users-container">
                    <h3>Знайдені користувачі:</h3>
                    {% for user in users %}
                    <div class="user-card">
                        <div class="user-avatar">{{ user.username[0] | upper }}</div>
                        <div class="user-info">
                            <h4>{{ user.full_name }}</h4>
                            <p class="username">@{{ user.username }}</p>
                            {% if user.city and user.country %}
                            <p class="location"><i class="fas fa-map-marker-alt"></i> {{ user.city }}, {{ user.country }}</p>
                            {% endif %}
                            {% if user.bio %}
                            <p class="bio">{{ user.bio }}</p>
                            {% endif %}
                        </div>
                        <div class="user-actions">
                            <a href="{{ url_for('profile', username=user.username) }}" class="btn btn-primary">Переглянути профіль</a>
                            <a href="{{ url_for('new_chat', user_id=user.id) }}" class="btn btn-secondary">Написати повідомлення</a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% elif search_city or search_country %}
                <div class="no-content">
                    <p>На жаль, користувачів за вашим запитом не знайдено.</p>
                </div>
                {% endif %}
            </div>

            {% elif action == 'messages' %}
            <!-- Список повідомлень -->
            <div class="messages-container">
                <h2>Повідомлення</h2>

                {% if contacts %}
                <div class="contacts-list">
                    {% for contact in contacts %}
                    <a href="{{ url_for('chat', user_id=contact.id) }}" class="contact-item {% if contact.unread_count > 0 %}unread{% endif %}">
                        <div class="contact-avatar">{{ contact.username[0] | upper }}</div>
                        <div class="contact-info">
                            <h4>{{ contact.full_name }}</h4>
                            <p class="username">@{{ contact.username }}</p>
                            <p class="last-message">{{ contact.last_message | truncate(50) }}</p>
                            <p class="message-time">{{ contact.last_message_time.strftime('%d.%m.%Y %H:%M') }}</p>
                            {% if contact.unread_count > 0 %}
                            <span class="unread-badge">{{ contact.unread_count }}</span>
                            {% endif %}
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-content">
                    <p>У вас ще немає повідомлень.</p>
                    <a href="{{ url_for('find_nearby_users') }}" class="btn btn-primary">Знайти учасників для спілкування</a>
                </div>
                {% endif %}
            </div>

            {% elif action == 'chat' %}
            <!-- Чат з користувачем -->
            <div class="chat-container">
                <div class="chat-header">
                    <div class="user-avatar">{{ recipient.username[0] | upper }}</div>
                    <div class="user-info">
                        <h3>{{ recipient.full_name }}</h3>
                        <p class="username">@{{ recipient.username }}</p>
                    </div>
                    <a href="{{ url_for('profile', username=recipient.username) }}" class="btn btn-secondary-small">Переглянути профіль</a>
                </div>

                <div class="chat-messages" id="chatMessages">
                    {% if messages %}
                    {% for message in messages %}
                    <div class="message {{ message.message_type }}">
                        <div class="message-content">
                            {{ message.content }}
                        </div>
                        <div class="message-time">
                            {{ message.created_at.strftime('%d.%m.%Y %H:%M') }}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="no-content">
                        <p>Почніть розмову з {{ recipient.full_name }}.</p>
                    </div>
                    {% endif %}
                </div>

                <form action="{{ url_for('chat', user_id=recipient.id) }}" method="post" class="message-form">
                    <div class="form-group">
                        <textarea name="message" placeholder="Введіть ваше повідомлення..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Надіслати</button>
                </form>
            </div>

            <script>
                // Прокрутка чату вниз при завантаженні
                document.addEventListener('DOMContentLoaded', function () {
                    var chatMessages = document.getElementById('chatMessages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            </script>

            {% elif action == 'admin_users' %}
            <!-- Адмін панель - користувачі -->
            <div class="admin-panel">
                <h2>Управління користувачами</h2>

                <div class="table-responsive">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Ім'я користувача</th>
                                <th>Повне ім'я</th>
                                <th>Email</th>
                                <th>Місто</th>
                                <th>Країна</th>
                                <th>Роль</th>
                                <th>Дата реєстрації</th>
                                <th>Дії</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>{{ user.id }}</td>
                                <td><a href="{{ url_for('profile', username=user.username) }}">{{ user.username }}</a></td>
                                <td>{{ user.full_name }}</td>
                                <td>{{ user.email }}</td>
                                <td>{{ user.city }}</td>
                                <td>{{ user.country }}</td>
                                <td>{{ 'Адміністратор' if user.role == 'admin' else 'Користувач' }}</td>
                                <td>{{ user.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                                <td>
                                    {% if user.id != session.user_id %}
                                    <form action="{{ url_for('delete_user', user_id=user.id) }}" method="post" class="inline-form">
                                        <button type="submit" class="btn btn-danger-small" onclick="return confirm('Ви впевнені, що хочете видалити цього користувача?')">
                                            <i class="fas fa-trash"></i> Видалити
                                        </button>
                                    </form>
                                    {% else %}
                                    <span class="disabled-action">Поточний користувач</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            {% elif action == 'admin_ideas' %}
            <!-- Адмін панель - ідеї -->
            <div class="admin-panel">
                <h2>Управління ідеями</h2>

                <div class="table-responsive">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Назва</th>
                                <th>Автор</th>
                                <th>Медіа</th>
                                <th>Дата створення</th>
                                <th>Дії</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for idea in ideas %}
                            <tr>
                                <td>{{ idea.id }}</td>
                                <td><a href="{{ url_for('view_idea', idea_id=idea.id) }}">{{ idea.title }}</a></td>
                                <td><a href="{{ url_for('profile', username=idea.username) }}">{{ idea.full_name if idea.full_name else idea.username }}</a></td>
                                <td>{{ idea.media_count }}</td>
                                <td>{{ idea.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                                <td>
                                    <a href="{{ url_for('view_idea', idea_id=idea.id) }}" class="btn btn-primary-small">
                                        <i class="fas fa-eye"></i> Переглянути
                                    </a>
                                    <a href="{{ url_for('edit_idea', idea_id=idea.id) }}" class="btn btn-secondary-small">
                                        <i class="fas fa-edit"></i> Редагувати
                                    </a>
                                    <form action="{{ url_for('delete_idea', idea_id=idea.id) }}" method="post" class="inline-form">
                                        <button type="submit" class="btn btn-danger-small" onclick="return confirm('Ви впевнені, що хочете видалити цю ідею?')">
                                            <i class="fas fa-trash"></i> Видалити
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 StartupHub. Всі права захищені.</p>
        </div>
    </footer>

    <script>
        // Геолокація
        document.addEventListener('DOMContentLoaded', function() {
            var getLocationBtn = document.getElementById('getLocationBtn');

            if (getLocationBtn) {
                getLocationBtn.addEventListener('click', function() {
                    var locationStatus = document.getElementById('locationStatus');

                    if (!navigator.geolocation) {
                        locationStatus.textContent = 'Геолокація не підтримується вашим браузером';
                        return;
                    }

                    locationStatus.textContent = 'Визначаємо ваше місцезнаходження...';

                    navigator.geolocation.getCurrentPosition(function(position) {
                        // Отримали координати
                        var latitude = position.coords.latitude;
                        var longitude = position.coords.longitude;

                        // Зберігаємо в прихованих полях
                        document.getElementById('latitude').value = latitude;
                        document.getElementById('longitude').value = longitude;

                        // Використовуємо Nominatim API для отримання назви міста та країни
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=10`)
                            .then(response => response.json())
                            .then(data => {
                                var city = data.address.city || data.address.town || data.address.village || '';
                                var country = data.address.country || '';

                                document.getElementById('city').value = city;
                                document.getElementById('country').value = country;

                                locationStatus.innerHTML = `<span style="color: green;">Місцезнаходження визначено: ${city}, ${country}</span>`;
                            })
                            .catch(error => {
                                locationStatus.innerHTML = `<span style="color: orange;">Координати отримано, але не вдалося визначити назву міста.</span>`;
                            });

                    }, function(error) {
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                locationStatus.innerHTML = '<span style="color: red;">Доступ до геолокації заборонено користувачем.</span>';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                locationStatus.innerHTML = '<span style="color: red;">Інформація про місцезнаходження недоступна.</span>';
                                break;
                            case error.TIMEOUT:
                                locationStatus.innerHTML = '<span style="color: red;">Час очікування визначення місцезнаходження минув.</span>';
                                break;
                            case error.UNKNOWN_ERROR:
                                locationStatus.innerHTML = '<span style="color: red;">Сталася невідома помилка.</span>';
                                break;
                        }
                    });
                });
            }
        });

        // Перевірка непрочитаних повідомлень
        function checkUnreadMessages() {
            {% if session.user_id %}
                fetch('{{ url_for("unread_message_count") }}')
                    .then(response => response.json())
                    .then(data => {
                        var unreadBadge = document.getElementById('unread-badge');
                        if (data.unread_count > 0) {
                            unreadBadge.textContent = data.unread_count;
                            unreadBadge.style.display = 'inline-block';
                        } else {
                            unreadBadge.style.display = 'none';
                        }
                    });
            {% endif %}
        }

        // Перевіряємо кожні 30 секунд
        document.addEventListener('DOMContentLoaded', function() {
            checkUnreadMessages();
            setInterval(checkUnreadMessages, 30000);
        });

        // Переконуємося, що сповіщення зникають через певний час
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                setTimeout(function() {
                    alert.style.display = 'none';
                }, 5000);
            });
        });
    </script>
</body>
</html>
